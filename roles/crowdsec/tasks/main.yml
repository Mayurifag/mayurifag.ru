---
- name: Get admin user info
  ansible.builtin.getent:
    database: passwd
    key: "{{ admin_username }}"

# - name: Remove CrowdSec Directories
#   ansible.builtin.file:
#     path: "{{ item }}"
#     state: absent
#   with_items:
# - "{{ crowdsec_data_directory }}"
# - "{{ crowdsec_config_directory }}"

- name: Create CrowdSec Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - "{{ crowdsec_data_directory }}"
    - "{{ crowdsec_config_directory }}"
    - "{{ crowdsec_config_directory }}/parsers/s02-enrich"

- name: Create acquisition config
  ansible.builtin.template:
    src: acquis.yaml.j2
    dest: "{{ crowdsec_config_directory }}/acquis.yaml"
    mode: "0644"

- name: Create profiles config
  ansible.builtin.template:
    src: profiles.yaml.j2
    dest: "{{ crowdsec_config_directory }}/profiles.yaml"
    mode: "0644"

- name: Create Whitelist configuration
  ansible.builtin.template:
    src: whitelist.yaml.j2
    dest: "{{ crowdsec_config_directory }}/parsers/s02-enrich/whitelist.yaml"
    mode: "0644"

- name: Ensure auth.log exists
  ansible.builtin.file:
    path: /var/log/auth.log
    state: touch
    mode: "0640"
  changed_when: false

- name: CrowdSec Docker Container
  community.docker.docker_container:
    name: crowdsec
    image: "{{ crowdsec_image }}"
    pull: true
    recreate: true
    restart_policy: unless-stopped
    networks:
      - name: "web"
    volumes:
      - "{{ crowdsec_data_directory }}:/var/lib/crowdsec/data"
      - "{{ crowdsec_config_directory }}:/etc/crowdsec"
      - "/var/log/auth.log:/var/log/auth.log:ro"
      - "{{ traefik_logs_directory }}:/var/log/traefik:ro"
    env:
      COLLECTIONS: "{{ crowdsec_collections | join(' ') }}"
      GID: "{{ ansible_facts.getent_passwd[admin_username][2] }}"
      UID: "{{ ansible_facts.getent_passwd[admin_username][1] }}"

- name: Wait for CrowdSec LAPI to be ready
  ansible.builtin.command: docker exec crowdsec cscli lapi status
  register: crowdsec_lapi_status
  until: crowdsec_lapi_status.rc == 0
  retries: 30
  delay: 2
  changed_when: false

- name: Create Traefik Bouncer
  ansible.builtin.shell: |
    docker exec crowdsec cscli bouncers delete traefik-bouncer || true
    docker exec crowdsec cscli bouncers add traefik-bouncer -o raw
  register: crowdsec_bouncer_key_output

- name: Configure CrowdSec Middleware for Traefik
  ansible.builtin.template:
    src: traefik_crowdsec.toml.j2
    dest: "{{ traefik_dynamic_configs_directory }}/crowdsec.toml"
    mode: "0644"
  vars:
    crowdsec_api_key: "{{ crowdsec_bouncer_key_output.stdout }}"

- name: Schedule CrowdSec hub update and upgrade
  ansible.builtin.cron:
    name: "CrowdSec hub update and upgrade"
    minute: "0"
    hour: "*/3"
    job: "docker exec crowdsec cscli hub update && docker exec crowdsec cscli hub upgrade"

- name: Check CrowdSec enrollment status
  ansible.builtin.command: docker exec crowdsec cscli console status
  register: crowdsec_enroll_status
  changed_when: false
  failed_when: false
  when:
    - crowdsec_enroll_key is defined
    - crowdsec_enroll_key != "change_me"
    - crowdsec_enroll_key | length > 0

- name: Enroll CrowdSec in Console
  when:
    - crowdsec_enroll_key is defined
    - crowdsec_enroll_key != "change_me"
    - crowdsec_enroll_key | length > 0
    - crowdsec_enroll_status is not skipped
    - "'Enrolled: true' not in crowdsec_enroll_status.stdout"
  block:
    - name: Register CAPI credentials
      ansible.builtin.command: docker exec crowdsec cscli capi register
      changed_when: true

    - name: Enroll using provided key
      ansible.builtin.command: >
        docker exec crowdsec cscli console enroll {{ crowdsec_enroll_key }}
        --name "{{ crowdsec_instance_name | default(server_hostname) }}"
      changed_when: true

    - name: Restart CrowdSec container after enrollment
      community.docker.docker_container:
        name: crowdsec
        restart: yes
        state: started

    - name: Wait for CrowdSec LAPI to be ready (after restart)
      ansible.builtin.command: docker exec crowdsec cscli lapi status
      register: crowdsec_lapi_status_after_enroll
      until: crowdsec_lapi_status_after_enroll.rc == 0
      retries: 30
      delay: 2
      changed_when: false
