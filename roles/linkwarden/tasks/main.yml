---
- name: Remove Linkwarden Docker Container if it exists
  community.docker.docker_container:
    name: linkwarden
    state: absent
    force_kill: yes

- name: Remove Linkwarden DB Container if it exists
  community.docker.docker_container:
    name: linkwarden-db
    state: absent
    force_kill: yes

- name: Remove linkwarden network
  community.docker.docker_network:
    name: linkwarden
    state: absent

- name: Remove Linkwarden Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ linkwarden_directory }}"

- name: Create Linkwarden Data Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ linkwarden_data_directory }}"
    - "{{ linkwarden_db_data_directory }}"

- name: Set Linkwarden Secrets
  ansible.builtin.set_fact:
    linkwarden_db_password: "{{ lookup('password', '/dev/null', length=32, chars='ascii_letters,digits,special') }}"
    linkwarden_nextauth_secret: "{{ lookup('password', '/dev/null', length=32, chars='ascii_letters,digits') }}"

- name: Set AI_TAGGING_ENABLED fact
  ansible.builtin.set_fact:
    ai_tagging_enabled: "{{ 'true' if linkwarden_openai_api_key != 'set_this_to_your_google_ai_studio_key' else 'false' }}"

- name: Create linkwarden network
  community.docker.docker_network:
    name: linkwarden
    state: present

- name: Linkwarden PostgreSQL Database Container
  community.docker.docker_container:
    name: "{{ linkwarden_db_host }}"
    image: "{{ linkwarden_db_image }}"
    pull: true
    recreate: true
    volumes:
      - "{{ linkwarden_db_data_directory }}:/var/lib/postgresql/data"
    env:
      POSTGRES_DB: "{{ linkwarden_db_name }}"
      POSTGRES_USER: "{{ linkwarden_db_user }}"
      POSTGRES_PASSWORD: "{{ linkwarden_db_password }}"
    restart_policy: unless-stopped
    memory: "{{ linkwarden_db_memory }}"
    networks:
      - name: "linkwarden"

- name: Linkwarden Docker Container
  community.docker.docker_container:
    name: linkwarden
    image: "{{ linkwarden_image }}"
    pull: true
    recreate: true
    volumes:
      - "{{ linkwarden_data_directory }}/:/data/data"
    env:
      DATABASE_URL: "postgresql://{{ linkwarden_db_user }}:{{ linkwarden_db_password }}@{{ linkwarden_db_host }}:{{ linkwarden_db_port }}/{{ linkwarden_db_name }}?schema=public"
      NEXTAUTH_URL: "https://{{ linkwarden_subdomain }}.{{ server_hostname }}"
      NEXT_PUBLIC_APP_URL: "https://{{ linkwarden_subdomain }}.{{ server_hostname }}"
      NEXTAUTH_SECRET: "{{ linkwarden_nextauth_secret }}"
      NODE_ENV: "production"
      AI_TAGGING_ENABLED: "{{ ai_tagging_enabled }}"
      CUSTOM_OPENAI_BASE_URL: "{{ linkwarden_openai_base_url }}"
      OPENAI_MODEL: "{{ linkwarden_openai_model }}"
      OPENAI_API_KEY: "{{ linkwarden_openai_api_key }}"
      PAGINATION_TAKE_COUNT: "{{ linkwarden_pagination_take_count }}"
    restart_policy: unless-stopped
    memory: "{{ linkwarden_memory }}"
    networks:
      - name: "web"
      - name: "linkwarden"
    labels:
      traefik.enable: "true"
      traefik.http.routers.linkwarden.rule: "Host(`{{ linkwarden_subdomain }}.{{ server_hostname }}`)"
      traefik.http.services.linkwarden.loadbalancer.server.port: "3000"
      traefik.http.routers.linkwarden.middlewares: "secure-headers@file"

      homepage.group: "Services"
      homepage.name: "Linkwarden"
      homepage.icon: "linkwarden.png"
      homepage.href: "https://{{ linkwarden_subdomain }}.{{ server_hostname }}"

- name: Wait for Linkwarden container to be healthy
  community.docker.docker_container_info:
    name: linkwarden
  register: linkwarden_info
  until: linkwarden_info.container is defined and linkwarden_info.container.State.Health.Status == "healthy"
  retries: 60
  delay: 5
  changed_when: false

- name: Create Linkwarden Admin User
  ansible.builtin.command: >
    docker exec linkwarden curl -L 'http://localhost:3000/api/v1/users' \
    -H 'Content-Type: application/json' \
    -H 'Accept: application/json' \
    --data-raw '{
      "name": "{{ admin_username }}",
      "password": "{{ admin_userldappassword }}",
      "email": "{{ linkwarden_admin_email }}",
      "username": "{{ admin_username }}"
    }'
  register: linkwarden_admin_init
  changed_when: linkwarden_admin_init.rc == 0
  failed_when: linkwarden_admin_init.rc not in [0, 22]
  when: ansible_check_mode is not defined or not ansible_check_mode

- name: Debug Linkwarden Admin User Creation Output
  ansible.builtin.debug:
    msg: "Linkwarden Admin User Creation Status: RC={{ linkwarden_admin_init.rc }}, STDOUT={{ linkwarden_admin_init.stdout | default('N/A') }}, STDERR={{ linkwarden_admin_init.stderr | default('N/A') }}"
  when:
    - linkwarden_admin_init is defined
    - linkwarden_admin_init.rc != 0 or linkwarden_admin_init.changed
    - ansible_check_mode is not defined or not ansible_check_mode
