---
- name: Create 3x-ui Directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - "{{ threexui_data_directory }}"
    - "{{ threexui_data_directory }}/db"
    - "{{ threexui_data_directory }}/cert"

- name: 3x-ui Docker Container
  community.docker.docker_container:
    name: 3x-ui
    image: "{{ threexui_docker_image }}"
    pull: true
    recreate: true
    volumes:
      - "{{ threexui_data_directory }}/db:/etc/x-ui:rw"
      - "{{ threexui_data_directory }}/cert:/root/cert:rw"
    env:
      XRAY_VMESS_AEAD_FORCED: "{{ threexui_vmess_aead_forced }}"
      XUI_ENABLE_FAIL2BAN: "{{ threexui_enable_fail2ban }}"
    restart_policy: unless-stopped
    memory: "{{ threexui_memory }}"
    tty: true
    labels:
      # Admin panel routing
      traefik.enable: "true"
      traefik.http.routers.threexui-panel.rule: "Host(`{{ threexui_subdomain }}.{{ server_hostname }}`)"
      traefik.http.routers.threexui-panel.entrypoints: "web,websecure"
      traefik.http.routers.threexui-panel.tls.certresolver: "letsencrypt"
      traefik.http.routers.threexui-panel.middlewares: "auth@file"
      traefik.http.routers.threexui-panel.service: "threexui-panel"
      traefik.http.services.threexui-panel.loadbalancer.server.port: "{{ threexui_panel_port }}"

      # VLESS+XHTTP routing (no auth, for proxy clients)
      traefik.http.routers.threexui-vless.rule: "Host(`{{ threexui_subdomain }}.{{ server_hostname }}`) && PathPrefix(`{{ threexui_xhttp_path }}`)"
      traefik.http.routers.threexui-vless.entrypoints: "web,websecure"
      traefik.http.routers.threexui-vless.tls.certresolver: "letsencrypt"
      traefik.http.routers.threexui-vless.priority: "100"
      traefik.http.routers.threexui-vless.service: "threexui-vless"
      traefik.http.services.threexui-vless.loadbalancer.server.port: "{{ threexui_vless_port }}"
